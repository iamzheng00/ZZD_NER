import datetime
import os
import numpy as np
import tensorflow as tf
import tensorflow.keras as keras
import tensorflow.keras.layers as layers
from tensorflow_addons.text import crf
from Utils import *
import time
from tqdm import tqdm
from conlleval import evaluate

tf.config.set_soft_device_placement(True)
gpus = tf.config.experimental.list_physical_devices(device_type='GPU')
for gpu in gpus:
    tf.config.experimental.set_memory_growth(gpu, True)


class conf():
    def __init__(self, choose_mod=None):

        self.tag_num = 16
        self.batchsize = 200
        self.LSTM_dim = 300
        self.ref_dim = 600

        self.optimizer = tf.optimizers.Adam(learning_rate=0.005)

        if choose_mod == None:
            self.mod = 'BiLSTM'
        else:
            self.mod = choose_mod


class Self_Attention(keras.layers.Layer):
    def __init__(self, units, dropout=0):
        super(Self_Attention, self).__init__()
        # self.WQ = layers.Dense(units, use_bias=False, trainable=True)
        # self.WK = layers.Dense(units, use_bias=False, trainable=True)
        # self.scale_k = units ** 0.5
        self.softmax = layers.Softmax()

    # def build(self, input_shape):
    #     self.W = self.add_variable('attention_variable',
    #                                shape=[int(input_shape[-1]),int(input_shape[-1])] )

    def call(self, input, **kwargs):
        Q = K = tf.nn.tanh(input)
        scaled_k = (Q.shape[-1]) ** 0.5
        scores = tf.matmul(Q, K, transpose_b=True)
        a = self.softmax(scores / scaled_k)
        c = tf.matmul(a, input)
        return c


class Model_NER(keras.Model):
    """
    没有embedding层，需做额外的embedding 再输入
    """

    def __init__(self, conf: conf):
        super(Model_NER, self).__init__()
        self.mod = conf.mod

        # 模型基本参数
        self.tag_num = conf.tag_num
        self.LSTM_dim = conf.LSTM_dim
        self.ref_dim = conf.ref_dim

        # 模型所需的层定义
        self.LSTM1 = layers.LSTM(self.LSTM_dim, return_sequences=True, go_backwards=False)
        self.LSTM2 = layers.LSTM(self.LSTM_dim, return_sequences=True, go_backwards=True)
        self.BiLSTM = layers.Bidirectional(self.LSTM1, backward_layer=self.LSTM2)
        self.dense = layers.Dense(self.tag_num)
        self.attentionlayer = Self_Attention(100)
        # self.attentionlayer = layers.Attention()
        self.mask = layers.Masking()
        # 模型内变量
        ## 转移矩阵
        self.trans_p = tf.Variable(
            tf.keras.initializers.GlorotUniform()([self.tag_num, self.tag_num]), name="transition_matrix"
        )
        ## 参考向量
        # self.ref_vector = tf.Variable(
        #     tf.keras.initializers.GlorotUniform()([self.tag_num, self.ref_dim]), name="reference_vector"
        # )
        ## O标签概率变量
        self.bO = tf.Variable(0.05, name="O_labelprob_scalar", trainable=True,dtype=tf.float32)
        self.optimizer = conf.optimizer

    def call(self, inputs, training=None, mask=None):
        '''

        :param inputs: [support_set, query_Set]
        :param training:
        :param mask:
        :return:
        '''
        support_set, query_set = inputs

        vector_S = self.BiLSTM(support_set['emb'])
        vector_Q = self.BiLSTM(query_set['emb'])
        lab_S = tf.one_hot(support_set['tag_ids'], self.tag_num)
        lab_Q = tf.one_hot(query_set['tag_ids'], self.tag_num)
        S_sent_num = vector_S.shape[0]
        S_sent_len = vector_S.shape[1]
        if self.mod == 'BiLSTM+proto':
            count_S = tf.reduce_sum(lab_S, axis=[1, 0])
            lab_S_expand = tf.tile(tf.expand_dims(lab_S, axis=-1), [1, 1, 1, self.ref_dim])
            # %%
            vector_S_expand = tf.tile(tf.expand_dims(vector_S, axis=-2), [1, 1, self.tag_num, 1])
            x = lab_S_expand * vector_S_expand
            vector_S_sum = tf.reduce_sum(x, axis=[1, 0])
            count_S = tf.expand_dims(count_S, axis=-1)
            # c = tf.where( count_S==0, 0 , 1/count_S )
            c = 1/(count_S + 0.0001)
            vector_S_ave = vector_S_sum * c

            # vector_proto = tf.expand_dims(tf.expand_dims(vector_S_ave,axis=-3),axis=-3)
            # vector_proto = tf.tile(vector_proto,[1,S_sent_num, S_sent_len, 1])
            distance = self.euclidean_distatnce(vector_Q, vector_S_ave)
            distance = tf.concat(
                [distance[:, :, :2],self.bO*tf.ones((distance.shape[0], distance.shape[1], 1), dtype=distance.dtype),
                 distance[:, :, 3:]],
                axis=-1)
            emission_score = tf.nn.softmax(-distance)
            # emission_score = tf.concat(
            #     [tf.zeros((emission_score.shape[0], emission_score.shape[1], 1), dtype=emission_score.dtype),
            #      emission_score[:, :, 1:3],
            #      0.05 * tf.ones((emission_score.shape[0], emission_score.shape[1], 1), dtype=emission_score.dtype),
            #      emission_score[:, :, 4:]],
            #     axis=-1)
            # pad和O标签概率用标量替代
            emission_score = tf.concat(
                [tf.zeros((emission_score.shape[0], emission_score.shape[1], 1), dtype=emission_score.dtype),
                 emission_score[:, :, 1:3],
                 0.001*tf.ones((emission_score.shape[0], emission_score.shape[1], 1),dtype=emission_score.dtype),
                 emission_score[:, :, 4:]],
                axis=-1)

        else:
            emission_score = self.dense(vector_Q)
        # x = self.attentionlayer(x)------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        return emission_score
        # return distance

    def euclidean_distatnce(self, Q, P):
        # TODO: Q 、P 维度检查
        sent_len = Q.shape[1]
        sent_num = Q.shape[0]
        Query = tf.tile(tf.expand_dims(Q, axis=-2), [1, 1, self.tag_num, 1])
        Query = tf.cast(Query, dtype=tf.float32)
        proto = tf.expand_dims(P, axis=-3)
        proto = tf.expand_dims(proto, axis=0)
        proto = tf.tile(proto, [sent_num, sent_len, 1, 1])
        d = tf.reduce_mean(tf.square(proto - Query), axis=-1)
        return d

    def crf_loss(self, input, tag_ids, sentence_len_list):
        likehood, self.trans_p = crf.crf_log_likelihood(inputs=input, tag_indices=tag_ids,
                                                        transition_params=self.trans_p,
                                                        sequence_lengths=sentence_len_list)
        loss = tf.reduce_mean(-likehood)
        return loss

    def validate_one_batch(self, test_batch, task_name, log_writer, epoch):
        S, Q = test_batch
        Q_tag_ids = Q['tag_ids']
        S_tag_ids = S['tag_ids']
        Q_seq_len_list = Q['lens']
        Q_seq_len_list_plus2 = [x + 2 for x in Q_seq_len_list]
        Q_tag_ids_padded = pad_tag_ids(Q_tag_ids)
        S_tag_ids_padded = pad_tag_ids(S_tag_ids)
        Q['tag_ids'] = Q_tag_ids_padded
        S['tag_ids'] = S_tag_ids_padded

        logits = self([S, Q])
        loss = self.crf_loss(logits, Q_tag_ids_padded, Q_seq_len_list_plus2)
        pred_tags, pred_best_score = crf.crf_decode(potentials=logits, transition_params=self.trans_p,
                                                    sequence_length=Q_seq_len_list_plus2)
        pred_tags_masked = seq_masking(pred_tags, Q_seq_len_list_plus2)
        p_tags_char, _ = get_id2tag_V2(pred_tags_masked, Q_seq_len_list_plus2, taskname=task_name)
        t_tags_char, _ = get_id2tag_V2(Q_tag_ids_padded, Q_seq_len_list_plus2, taskname=task_name)
        (P, R, F1), _ = evaluate(t_tags_char, p_tags_char, verbose=True)
        write_to_log(loss, P, R, F1, t_tags_char, log_writer, epoch)
        return (loss, pred_tags_masked, Q_tag_ids_padded, P, R, F1)

    def inner_train_one_step(self, batch, inner_iters, inner_epochNum, outer_epochNum, task_name,
                             log_writer):
        '''
        :param self:
        :param batch: batches = [S,Q]
                        S,Q: [[sentence],[sentence],....]
                        sentence=[emb:[],chars:[],tags:[],tag_ids:[]]
        :param inner_epochNum:
        :return:
        '''

        batches_len = len(batch)

        # =====run model=======

        S, Q = batch
        Q_tag_ids = Q['tag_ids']
        S_tag_ids = S['tag_ids']
        Q_seq_len_list = Q['lens']
        Q_seq_len_list_plus2 = [x + 2 for x in Q_seq_len_list]
        Q_tag_ids_padded = pad_tag_ids(Q_tag_ids)
        S_tag_ids_padded = pad_tag_ids(S_tag_ids)
        Q['tag_ids'] = Q_tag_ids_padded
        S['tag_ids'] = S_tag_ids_padded

        with tf.GradientTape() as tape:
            logits = self([S, Q])
            loss = self.crf_loss(logits, Q_tag_ids_padded, Q_seq_len_list_plus2)
            pred_tags, pred_best_score = crf.crf_decode(potentials=logits, transition_params=self.trans_p,
                                                        sequence_length=Q_seq_len_list_plus2)
        grads = tape.gradient(loss, self.trainable_variables)
        self.optimizer.apply_gradients(zip(grads, self.trainable_variables))
        # optimizer.minimize(loss, [myModel_bilstm.trainable_variables])

        pred_tags_masked = seq_masking(pred_tags, Q_seq_len_list_plus2)
        p_tags_char, p_tagsid_flatten = get_id2tag_V2(pred_tags_masked, Q_seq_len_list_plus2, taskname=task_name)
        t_tags_char, t_tagsid_flatten = get_id2tag_V2(Q_tag_ids_padded, Q_seq_len_list_plus2, taskname=task_name)
        (P_t, R_t, F1_t), _ = evaluate(t_tags_char, p_tags_char, verbose=False)
        with log_writer.as_default():
            # step = batch_num + 1 + inner_epochNum * batches_len
            tf.summary.scalar("loss", loss, step=inner_epochNum + outer_epochNum * inner_iters)
            tf.summary.scalar("P", P_t, step=inner_epochNum + outer_epochNum * inner_iters)
            tf.summary.scalar("R", R_t, step=inner_epochNum + outer_epochNum * inner_iters)
            tf.summary.scalar("F", F1_t, step=inner_epochNum + outer_epochNum * inner_iters)
        return (loss, P_t, R_t, F1_t)


if __name__ == '__main__':
    cof = conf()
    model = Model_NER(cof)
    e = tf.ones([200, 52, 768])
    x = model(e)
    print(model.BiLSTM.trainable_variables)
